<!-- snippets/product-quantity -->
{%- comment -%}
  Effective quantity rules: variant metafield custom.minimum_quantity overrides
  when set; otherwise theme fallbacks (pavers 80/180) or variant.quantity_rule.
  We output per-variant rules as JSON so JS can update the quantity input on variant change.
  Callers may pass is_pavers and is_recycled; if not passed, we infer from product.
{%- endcomment -%}
{%- liquid
  if is_pavers == nil
    assign is_pavers = false
    for collection in product.collections
      if collection.handle == 'pavers'
        assign is_pavers = true
        break
      endif
    endfor
  endif
  if is_recycled == nil
    assign is_recycled = false
    if product.title contains 'Recycled'
      assign is_recycled = true
    endif
  endif
-%}
{%- capture variant_quantity_rules_json -%}
  {%- for v in product.variants -%}
    {%- liquid
      assign mf = v.metafields.custom.minimum_quantity
      assign mf_min = blank
      if mf != blank
        assign mf_val = mf.value
        if mf_val == blank or mf_val == 0
          assign mf_val = mf | plus: 0
        endif
        if mf_val != blank and mf_val > 0
          assign mf_min = mf_val
        endif
      endif
      if mf_min != blank
        assign eff_min = mf_min
        assign eff_step = mf_min
      elsif is_pavers
        if is_recycled
          assign eff_min = 180
          assign eff_step = 180
        else
          assign eff_min = 80
          assign eff_step = 80
        endif
      else
        assign eff_min = v.quantity_rule.min
        assign eff_step = v.quantity_rule.increment
      endif
      if is_pavers
        assign eff_max = 400
      else
        assign eff_max = v.quantity_rule.max
      endif
    -%}
    "{{ v.id }}":{"min":{{ eff_min }},"max":{% if eff_max %}{{ eff_max }}{% else %}null{% endif %},"step":{{ eff_step }}}{% unless forloop.last %},{% endunless %}
  {%- endfor -%}
{%- endcapture -%}
<div
  id="Quantity-Form-{{ section.id }}"
  class="product-form__input product-form__quantity{% if settings.inputs_shadow_vertical_offset != 0 and settings.inputs_shadow_vertical_offset < 0 %} product-form__quantity-top{% endif %}"
  {{ block.shopify_attributes }}
  data-variant-quantity-rules="{ {{ variant_quantity_rules_json }} }"
>
  {% comment %} TODO: enable theme-check once `item_count_for_variant` is accepted as valid filter {% endcomment %}
  {% # theme-check-disable %}
  {%- assign cart_qty = cart | item_count_for_variant: product.selected_or_first_available_variant.id -%}
  {% # theme-check-enable %}
  <label class="quantity__label form__label" for="Quantity-{{ section.id }}">
    {{ 'products.product.quantity.label' | t }}
    <span class="quantity__rules-cart no-js-hidden{% if cart_qty == 0 %} hidden{% endif %}">
      <span class="loading-overlay hidden">
        <span class="loading-overlay__spinner">
          <svg
            aria-hidden="true"
            focusable="false"
            class="spinner"
            viewBox="0 0 66 66"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
          </svg>
        </span>
      </span>
      <span>({{- 'products.product.quantity.in_cart_html' | t: quantity: cart_qty -}})</span>
    </span>
  </label>
  <quantity-input class="quantity">
    <span class="qtyLabel" {% unless is_pavers %}style="display:none" {% endunless %}>sqft</span>
    <button class="quantity__button no-js-hidden" name="minus" type="button">
      <span class="visually-hidden">
        {{- 'products.product.quantity.decrease' | t: product: product.title | escape -}}
      </span>
      {% render 'icon-minus' %}
    </button>
    {%- liquid
      assign sel = product.selected_or_first_available_variant
      assign variant_rule = sel.quantity_rule
      assign mf = sel.metafields.custom.minimum_quantity
      assign mf_min = blank
      if mf != blank
        assign mf_val = mf.value
        if mf_val == blank or mf_val == 0
          assign mf_val = mf | plus: 0
        endif
        if mf_val != blank and mf_val > 0
          assign mf_min = mf_val
        endif
      endif
      if mf_min != blank
        assign effective_min = mf_min
        assign effective_increment = mf_min
      elsif is_pavers
        if is_recycled
          assign effective_min = 180
          assign effective_increment = 180
        else
          assign effective_min = 80
          assign effective_increment = 80
        endif
      else
        assign effective_min = variant_rule.min
        assign effective_increment = variant_rule.increment
      endif
      if is_pavers
        assign effective_max = 400
      else
        assign effective_max = variant_rule.max
      endif
    -%}
    <input
      class="quantity__input"
      type="number"
      name="quantity"
      id="Quantity-{{ section.id }}"
      {% if is_pavers %}
        data-paver
        {% if is_recycled %}
          data-recycled
        {% endif %}
        min="{{ effective_min }}"
        data-min="{{ effective_min }}"
        max="{{ effective_max }}"
        data-max="{{ effective_max }}"
        step="{{ effective_increment }}"
        value="{{ effective_min }}"
      {% else %}
        min="{{ effective_min }}"
        data-min="{{ effective_min }}"
        {% if effective_max %}
          max="{{ effective_max }}"
          data-max="{{ effective_max }}"
        {% endif %}
        step="{{ effective_increment }}"
        value="{{ effective_min }}"
      {% endif %}
      form="{{ product_form_id }}"
    />
    <button class="quantity__button no-js-hidden" name="plus" type="button">
      <span class="visually-hidden">
        {{- 'products.product.quantity.increase' | t: product: product.title | escape -}}
      </span>
      {% render 'icon-plus' %}
    </button>
  </quantity-input>
</div>