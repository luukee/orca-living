{% assign article_sections = article.metafields.blog.sections.value %}
{% if article_sections %}
  {% for section in article_sections %}
    {% if section.images %}
      {% comment %}This is a gallery_section{% endcomment %}
      <section class='post-sections--gallery article-template__image-gallery'>
        <div class='cell half_gutter vert-top'>
          {% if section.images.value %}
            {% for image in section.images.value %}
              <div class='cell__item medium-up--one-half'>
                <div class='inner-container'>
                  {{ image | image_url: width: 600 | image_tag: loading: 'lazy' }}
                </div>
              </div>
            {% endfor %}
          {% endif %}
        </div>
      </section>
    {% elsif section.text_image %}
      {% comment %}This is a text_image_section{% endcomment %}
      <section
        class='post-sections post-sections--text-image two-grid-section{% if section.section_background_color %} post-sections--text-image--background{% endif %}'
        {% if section.section_background_color %}
          style='background-color: {{ section.background_color }};'
        {% endif %}
      >
        <div class='cell half_gutter vert-top'>
          <div class='cell__item'>
            <div class='two-grid'>
              <div class='rte caption{% if section.flip_order == true %} order-2{% endif %}'>
                {% if section.body %}
                  {{ section.body | metafield_tag }}
                {% endif %}
              </div>
              <div class='image'>
                {{ section.text_image | image_url: width: 600 | image_tag: loading: 'lazy' }}
              </div>
            </div>
          </div>
        </div>
      </section>
    {% elsif section.text_section_body %}
      {% comment %}This is a text_section. Rich text metafield.{% endcomment %}
      <section class='post-sections post-sections--text'>
        <div class='rte'>
          {% if section.text_section_body %}
            {{ section.text_section_body | metafield_tag }}
          {% endif %}
          {% if section.podcast_embed_code %}
            {% assign embed_code = section.podcast_embed_code.value | default: section.podcast_embed_code %}
          
            {% if embed_code contains 'src="' %}
              {% comment %} Extract src from pasted iframe embed code {% endcomment %}
              {% assign after_src = embed_code | split: 'src="' | last %}
              {% assign src = after_src | split: '"' | first %}
          
              {% comment %} Provider detection + basic safety whitelist {% endcomment %}
              {% assign provider = '' %}
              {% assign iframe_height = 152 %}
          
              {% if src contains 'open.spotify.com/embed' %}
                {% assign provider = 'spotify' %}
                {% assign iframe_height = 152 %}
          
                {% comment %} Spotify show embeds are often taller {% endcomment %}
                {% if src contains '/show/' %}
                  {% assign iframe_height = 232 %}
                {% endif %}
              {% elsif src contains 'embed.podcasts.apple.com' %}
                {% assign provider = 'apple' %}
                {% assign iframe_height = 175 %}
              {% endif %}
          
              {% if provider != '' %}
                <div class="podcast-embed podcast-embed--{{ provider }}">
                  <iframe
                    src="{{ src }}"
                    width="100%"
                    height="{{ iframe_height }}"
                    frameborder="0"
                    allowfullscreen
                    {% comment %} Allow list tuned for both Spotify + Apple Podcasts {% endcomment %}
                    allow="autoplay *; clipboard-write; encrypted-media *; fullscreen *; picture-in-picture"
                    loading="lazy"
                    title="Podcast"
                    {% comment %} Apple Podcasts uses sandbox on their snippet, include it only when needed {% endcomment %}
                    {% if provider == 'apple' %}
                      sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
                    {% endif %}
                  ></iframe>
                </div>
              {% endif %}
            {% endif %}
          {% endif %}
        </div>
      </section>
    {% elsif section.full_width_image %}
      {% comment %}This is a full_width_image_section{% endcomment %}
      <section class='post-sections post-sections--full-width-image rte'>
        {% if section.image_height != blank %}
          {% assign height = section.image_height %}
        {% else %}
          {% assign height = 800 %}
        {% endif %}
        {% assign focal_point = section.full_width_image.presentation.focal_point %}
        {% assign image_style = 'object-fit: cover;' %}
        {% if focal_point != blank %}
          {% assign image_style = image_style | append: ' object-position: ' | append: focal_point | append: ';' %}
        {% endif %}
        {{ section.full_width_image | image_url: height: height | image_tag: loading: 'lazy', class: 'standardized-image', style: image_style, alt: section.full_width_image.alt }}
      </section>
    {% elsif section.first_image %}
      {% comment %}This is a two_grid_section{% endcomment %}
      <section class='post-sections post-sections--two-grid two-grid-section'>
        <div class='cell half_gutter vert-top'>
          <div class='cell__item'>
            <div class='two-grid'>
              <div class='{% if section.first_image_caption %}caption{% else %}image{% endif %}'>
                {{ section.first_image | image_url: width: 600 | image_tag: loading: 'lazy' }}
              </div>
              <div class='{% if section.second_image_caption %}caption{% else %}image{% endif %}'>
                {{ section.second_image | image_url: width: 600 | image_tag: loading: 'lazy' }}
              </div>
            </div>
          </div>
        </div>
      </section>
    {% elsif section.quote_text %}
      {% comment %}This is a quote_section{% endcomment %}
      <section class='post-sections post-sections--quote'>
        <p>
          <em> "{{ section.quote_text }}" </em>
        </p>
      </section>
    {% endif %}
  {% endfor %}
{% endif %}
{% render 'css-post-sections' %}