{% if article.metafields["custom_fields"]["related_products"] != blank %}
{% style %}

{% if block.settings.title_font_custom != blank %}{{ block.settings.title_font | font_face }}{% endif %}

#block-{{ block.id }} {
  {% if block.settings.title_font_custom != blank %}
  --title-font-weight: {{ block.settings.title_font.weight }};
  --title-font-style: {{ block.settings.title_font.style }};
  --title-font-family: {{ block.settings.title_font.family }};
  {% endif %}
  --block-bg-color: {{ block.settings.block_bg_color }};
  --margin-top: {{ block.settings.margin_top }}rem;
  --margin-bottom: {{ block.settings.margin_bottom }}rem;
  --title-font-size: {{ block.settings.title_font_size }}px;
  --title-font-color: {{ block.settings.title_font_color }};
  --title-margin-top: {{ block.settings.title_margin_top }}rem;
  --title-margin-bottom: {{ block.settings.title_margin_bottom }}rem;
  --title-line-height: {{ block.settings.title_line_height }}em;
  --card-bg-color: {{ block.settings.card_bg_color }};
  --card-border: {{ block.settings.card_border }};
  --card-border-radius: {{ block.settings.card_border_radius }};
  --card-box-shadow: {{ block.settings.card_box_shadow }};
  --body-font-size: {{ block.settings.body_font_size }}px;
  --body-font-color: {{ block.settings.body_font_color }};
  --body-margin-bottom: {{ block.settings.body_margin_bottom }}rem;
  --image-border: {{ block.settings.image_border }};
  --image-border-radius: {{ block.settings.image_border_radius }};
  --image-box-shadow: {{ block.settings.image_box_shadow }};
  --link-padding: {{ block.settings.link_padding }};
  --link-bg-color: {{ block.settings.link_bg_color }};
  --link-hover-bg-color: {{ block.settings.link_hover_bg_color }};
  --link-border: {{ block.settings.link_border }};
  --link-border-radius: {{ block.settings.link_border_radius }};
  --link-font-color: {{ block.settings.link_font_color }};
  --link-hover-font-color: {{ block.settings.link_hover_font_color }};
  --link-font-size: {{ block.settings.link_font_size }}px;
  --price-padding: {{ block.settings.price_padding }};
  --price-bg-color: {{ block.settings.price_bg_color }};
  --price-border: {{ block.settings.price_border }};
  --price-border-radius: {{ block.settings.price_border_radius }};
  --price-font-color: {{ block.settings.price_font_color }};
  --price-font-size: {{ block.settings.price_font_size }}px;
  --price-margin-bottom: {{ block.settings.price_margin_bottom }}rem;
  --stock-padding: {{ block.settings.stock_padding }};
  --stock-bg-color: {{ block.settings.stock_bg_color }};
  --stock-border: {{ block.settings.stock_border }};
  --stock-border-radius: {{ block.settings.stock_border_radius }};
  --stock-font-color: {{ block.settings.stock_font_color }};
  --stock-font-size: {{ block.settings.stock_font_size }}px;
  --stock-margin-bottom: {{ block.settings.stock_margin_bottom }}rem;
  --column-gutter: {{ block.settings.column_gutter }}px;
  --mobile-columns: repeat({{ block.settings.widget_mobile_grid_width }}, 1fr);
  {% if block.settings.margin_top != blank %}padding-top: var(--margin-top);{% endif %}
  {% if block.settings.margin_bottom != blank %}padding-bottom: var(--margin-bottom);{% endif %}
  {% if block.settings.block_bg_color != blank %}background-color: var(--block-bg-color);{% endif %}
  {% if block.settings.text_center != blank %}
  text-align: center;
  {% endif %}
}

#block-{{ block.id }} .cf-widget-items-wrapper {
  {% if block.settings.column_gutter != blank %}
  grid-column-gap: var(--column-gutter);
  grid-row-gap: var(--column-gutter);
  {% endif %}
}

@media screen and (max-width: 768px) {
  #block-{{ block.id }} .cf-widget-items-wrapper {
    grid-template-columns: var(--mobile-columns);
  }
}

#block-{{ block.id }} .cf-widget-items-wrapper .cf-widget-item {
 {% if block.settings.card_bg_color != blank %}background-color: var(--card-bg-color);{% endif %}
  {% if block.settings.card_border != blank %}border: var(--card-border);{% endif %}
  {% if block.settings.card_border_radius != blank %}border-radius: var(--card-border-radius);{% endif %}
  {% if block.settings.card_box_shadow != blank %}box-shadow: var(--card-box-shadow);{% endif %}
}

#block-{{ block.id }} .cf-product-image {
{% if block.settings.image_border != blank %}border: var(--image-border);{% endif %}
  {% if block.settings.image_border_radius != blank %}border-radius: var(--image-border-radius);{% endif %}
  {% if block.settings.image_box_shadow != blank %}box-shadow: var(--image-box-shadow);{% endif %}
  {% case block.settings.image_size %}
    {% when "large" %}
    max-width: 85%;
    {% when "medium" %}
    max-width: 50%;
    {% when "small" %}
    max-width: 25%;
  {% endcase %}
}

#block-{{ block.id }} .cf-product-title {
  {% if block.settings.title_font_size != blank %}font-size: var(--title-font-size);{% endif %}
  {% if block.settings.title_font_color != blank %}color: var(--title-font-color);{% endif %}
  {% if block.settings.title_margin_top != blank %}margin-top: var(--title-margin-top);{% endif %}
  {% if block.settings.title_margin_bottom != blank %}margin-bottom: var(--title-margin-bottom);{% endif %}
  {% if block.settings.title_line_height != blank %}line-height: var(--title-line-height);{% endif %}
  {% if block.settings.title_font_custom != blank %}
  font-weight: var(--title-font-weight) !important;
  font-style: var(--title-font-style) !important;
  font-family: var(--title-font-family) !important;
  {% endif %}
}

#block-{{ block.id }} .cf-product-price {
  {% if block.settings.price_margin_bottom != blank %}margin-bottom: var(--price-margin-bottom);{% endif %}
}

#block-{{ block.id }} .cf-product-price .inner {
  {% if block.settings.price_font_size != blank %}font-size: var(--price-font-size);{% endif %}
  {% if block.settings.price_font_color != blank %}color: var(--price-font-color);{% endif %}
  {% if block.settings.price_bg_color != blank %}background-color: var(--price-bg-color);{% endif %}
  {% if block.settings.price_padding != blank %}padding: var(--price-padding);{% endif %}
  {% if block.settings.price_border != blank %}border: var(--price-border);{% endif %}
  {% if block.settings.price_border_radius != blank %}border-radius: var(--price-border-radius);{% endif %}
  display: inline-block;
}

#block-{{ block.id }} .cf-product-stock-notice {
  {% if block.settings.stock_margin_bottom != blank %}margin-bottom: var(--stock-margin-bottom);{% endif %}
  line-height: 1.0rem;
}

#block-{{ block.id }} .cf-product-stock-notice .inner {
  {% if block.settings.stock_font_size != blank %}font-size: var(--stock-font-size);{% endif %}
  {% if block.settings.stock_font_color != blank %}color: var(--stock-font-color);{% endif %}
  {% if block.settings.stock_bg_color != blank %}background-color: var(--stock-bg-color);{% endif %}
  {% if block.settings.stock_padding != blank %}padding: var(--stock-padding);{% endif %}
  {% if block.settings.stock_border != blank %}border: var(--stock-border);{% endif %}
  {% if block.settings.stock_border_radius != blank %}border-radius: var(--stock-border-radius);{% endif %}
  display: inline-block;
}

#block-{{ block.id }} .cf-widget-field__description {
  {% if block.settings.body_font_size != blank %}font-size: var(--body-font-size);{% endif %}
  {% if block.settings.body_font_color != blank %}color: var(--body-font-color);{% endif %}
  {% if block.settings.body_margin_bottom != blank %}margin-bottom: var(--body-margin-bottom);{% endif %}
}

#block-{{ block.id }} .cf-product-custom-link-text {
  {% if block.settings.link_font_size != blank %}font-size: var(--link-font-size);{% endif %}
  {% if block.settings.link_font_color != blank %}color: var(--link-font-color);{% endif %}
  {% if block.settings.link_bg_color != blank %}background-color: var(--link-bg-color);{% endif %}
  {% if block.settings.link_padding != blank %}padding: var(--link-padding);{% endif %}
  {% if block.settings.link_border != blank %}border: var(--link-border);{% endif %}
  {% if block.settings.link_border_radius != blank %}border-radius: var(--link-border-radius);{% endif %}
  {% if block.settings.link_full_width != blank %}width: 100%;{% endif %}
  text-decoration:none;
}

#block-{{ block.id }} .cf-widget-item:hover .cf-product-custom-link-text {
  {% if block.settings.link_hover_bg_color != blank %}background-color: var(--link-hover-bg-color);{% endif %}
  {% if block.settings.link_hover_font_color != blank %}color: var(--link-hover-font-color);{% endif %}
}

{% if block.settings.section_title_text != blank %}
#block-{{ block.id }} .cf-widget-section-title {
  {% if block.settings.section_title_margin_bottom != blank %}margin-bottom: {{ block.settings.section_title_margin_bottom }}em;{% endif %}
}
{% endif %}

{% if block.settings.section_title_color != blank %}
#block-{{ block.id }} .cf-widget-section-title {{ block.settings.section_title_tag }}{
  color: {{ block.settings.section_title_color }};
}
{% endif %}

{% assign image_width = 500 %}
{% assign image_height = blank %}

{% case block.settings.image_ratio %}
  {% when "landscape" %}
    {% assign image_height = 350 %}
  {% when "portrait" %}
    {% assign image_height = 750 %}
  {% when "square" %}
    {% assign image_height = 500 %}
{% endcase %}

{% endstyle %}
<div class="cf-widget-related-products cf-grid cf-widget__product-references-v2" id="block-{{ block.id }}"
     data-grid-width="{{ block.settings.widget_grid_width }}">
  {% if block.settings.section_title_text != blank %}
  <div class="cf-widget-section-title">
    <{{ block.settings.section_title_tag }} class="cf-widget-sectiont-title__text">{{ block.settings.section_title_text }}</{{ block.settings.section_title_tag }}>
  </div>
  {% endif %}
  <div class="cf-widget-items-wrapper">
    {% for item in article.metafields["custom_fields"]["related_products"] %}
    {% assign product = all_products[item.handle] %}
    {% if product.published_at != blank %}
    <div class="cf-widget-item {% if product.available != true and settings.hide_out_of_stock != 1 %}cf-widget-item--out-of-stock{% endif %} {% if block.settings.widget_link_title != blank %}cf-widget-item--has-custom-link{% endif %}">
      <div class="inner">
        <a href="{{ product.url }}" class="cf-product-link"></a>
        <div class="cf-product-image-wrapper">
          {% assign image_scale = image_width | append: "x" %}
          {% if image_height != blank %}
          {% assign image_scale = image_scale | append: image_height %}
          {% endif %}
          {% if product.featured_image.src != blank %}
          <img src="{{ product | img_url: image_scale, crop: "center" }}" class="cf-product-image">
          {% else %}
          <img src="{{ block.settings.default_image | img_url: image_scale, crop: "center" }}" class="cf-product-image">
          {% endif %}
        </div>
        <div class="cf-product-info">
          <div class="cf-product-title">
            {% if item.title_override != blank %}
            {{ item.title_override }}
            {% else %}
            {{ product.title | truncate: 40 }}
            {% endif %}
          </div>

          {% unless block.settings.widget_hide_price %}
          <div class="cf-product-price">
            <div class="inner">{{ product.price | money }}</div>
          </div>
          {% endunless %}

          {% if product.available != true %}
          {% unless block.settings.widget_hide_out_of_stock %}
          <div class="cf-product-stock-notice">
            <div class="inner">
              {{ 'products.product.sold_out' | t }}
            </div>
          </div>
          {% endunless %}
          {% endif %}

          
            {% if item.description != blank %}
            <div class="cf-widget-field cf-widget-field__description cf-widget-field--html">
              {{ item.description }}
            </div>
            {% endif %}
                  </div>

        {% if block.settings.widget_link_title != blank %}
        <div class="cf-product-custom-link">
          <a class="cf-product-custom-link-text" href="{{ product.url }}">
            {{ block.settings.widget_link_title }}
          </a>
        </div>
        {% endif %}

      </div>
    </div>
    {% endif %}
    {% endfor %}
  </div>
</div>
{% endif %}
