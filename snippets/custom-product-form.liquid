{% comment %}
  Renders custom product form with required fields.
  Accepts:
  - product: {Object} product object.
  - block: {Object} passing the block information.
  - form: {Object} the product form object.
  - section: {Object} section to which this snippet belongs.

  Usage:
  {% render 'custom-product-form', product: product, block: block, form: form, section: section %}
{% endcomment %}
{{ 'section-contact-form.css' | asset_url | stylesheet_tag }}

<form id='custom_product_form' class='custom-product-form'>
  <div class='form__message' style='display: none;'></div>

  <div class='custom-form__fields'>
    {% comment %} First Name, Last Name {% endcomment %}
    <div class='field-row'>
      <div class='field'>
        <input
          class='field__input{% if form.errors contains "FirstName" %} invalid{% endif %}'
          id='FirstName-{{ section.id }}'
          name='FirstName'
          type='text'
          required
          placeholder='First Name'
        >
        <label class='field__label' for='FirstName-{{ section.id }}'> First Name* </label>
      </div>

      <div class='field'>
        <input
          class='field__input{% if form.errors contains "LastName" %} invalid{% endif %}'
          id='LastName-{{ section.id }}'
          name='LastName'
          type='text'
          required
          placeholder='Last Name'
        >
        <label class='field__label' for='LastName-{{ section.id }}'> Last Name* </label>
      </div>
    </div>

    {% comment %} Email, Phone {% endcomment %}
    <div class='field-row'>
      <div class='field'>
        <input
          class='field__input{% if form.errors contains "email" %} invalid{% endif %}'
          id='Email-{{ section.id }}'
          name='Email'
          type='email'
          required
          placeholder='Email'
        >
        <label class='field__label' for='Email-{{ section.id }}'> Email* </label>
      </div>

      <div class='field'>
        <input
          class='field__input{% if form.errors contains "phone" %} invalid{% endif %}'
          id='Phone-{{ section.id }}'
          name='Phone'
          type='tel'
          required
          autocomplete='tel'
          placeholder='Phone number'
        >
        <label class='field__label' for='Phone-{{ section.id }}'> Phone number* </label>
      </div>
    </div>
    
    {% comment %} Role field {% endcomment %}
    <div class='field'>
      <label class='field__label visually-hidden' for='Role-{{ section.id }}'> Individual/Business* </label>
      <div class='select'>
        <select
          class='select__select{% if form.errors contains "Role" %} invalid{% endif %}'
          id='Role-{{ section.id }}'
          name='Role'
          required
        >
          <option value=''>- Individual/Business</option>
          <option
            value='Landscape Designer'
            {% if form.Role == 'Landscape Designer' %}
              selected
            {% endif %}
          >
            Landscape Designer
          </option>
          <option
            value='Contractor'
            {% if form.Role == 'Contractor' %}
              selected
            {% endif %}
          >
            Contractor
          </option>
          <option
            value='Architect'
            {% if form.Role == 'Architect' %}
              selected
            {% endif %}
          >
            Architect
          </option>
          <option
            value='Interior Designer'
            {% if form.Role == 'Interior Designer' %}
              selected
            {% endif %}
          >
            Interior Designer
          </option>
          <option
            value='Individual'
            {% if form.Role == 'Individual' %}
              selected
            {% endif %}
          >
            Individual
          </option>
          <option
            value='Other'
            {% if form.Role == 'Other' %}
              selected
            {% endif %}
          >
            Other
          </option>
        </select>
      </div>
    </div>

    {% comment %} Address - Street Address, City {% endcomment %}
    <div class='field-row'>
      {% comment %} Street Address {% endcomment %}
      <div class='field'>
        <input
          class='field__input{% if form.errors contains "Street Address" %} invalid{% endif %}'
          id='Street Address-{{ section.id }}'
          name='Street Address'
          type='text'
          required
          placeholder='Street Address'
        >
        <label class='field__label' for='Street Address-{{ section.id }}'> Street Address* </label>
      </div>

      {% comment %} City {% endcomment %}
      <div class='field'>
        <input
          class='field__input{% if form.errors contains "LastName" %} invalid{% endif %}'
          id='City-{{ section.id }}'
          name='City'
          type='text'
          required
          placeholder='City'
        >
        <label class='field__label' for='City-{{ section.id }}'> City* </label>
      </div>
    </div>

    {% comment %} Address - State, Zip {% endcomment %}
    <div class='field-row'>
      {% comment %} State {% endcomment %}
      <div class='field'>
        <input
          class='field__input{% if form.errors contains "State" %} invalid{% endif %}'
          id='State-{{ section.id }}'
          name='State'
          type='text'
          required
          placeholder='State'
        >
        <label class='field__label' for='State-{{ section.id }}'> State* </label>
      </div>

      {% comment %} Zip {% endcomment %}
      <div class='field'>
        <input
          class='field__input{% if form.errors contains "Zip" %} invalid{% endif %}'
          id='Zip-{{ section.id }}'
          name='Zip'
          type='text'
          required
          placeholder='Zip'
        >
        <label class='field__label' for='Zip-{{ section.id }}'> Zip* </label>
      </div>
      <div class='field field--note'>
        <p>Please note: we ship Rock only within the Southern California region at this time.</p>
      </div>
    </div>
      
    
    {% comment %} Square footage field {% endcomment %}
    <div class='field'>
      <input
        class='field__input{% if form.errors contains "Square Footage" %} invalid{% endif %}'
        id='Square Footage-{{ section.id }}'
        name='Square Footage'
        type='number'
        placeholder='Square Footage'
      >
      <label class='field__label' for='Square Footage-{{ section.id }}'>Approximate Square Footage</label>
    </div>

    {% comment %} Material interest field {% endcomment %}
    <div class='field field--checkbox'>
      <label class='field__label field__label--checkbox'>Material Interest (select as many as you'd like)</label>
      <div class='checkbox-group'>
        <div class='checkbox-item'>
          <input
            type='checkbox'
            id='PathFines-{{ section.id }}'
            name='Material Interest'
            value='Path Fines'
            class='checkbox__input{% if form.errors contains "Material Interest" %} invalid{% endif %}'
          >
          <label class='checkbox__label' for='PathFines-{{ section.id }}'>Path Fines</label>
        </div>
        <div class='checkbox-item'>
          <input
            type='checkbox'
            id='Gravel-{{ section.id }}'
            name='Material Interest'
            value='Gravel'
            class='checkbox__input{% if form.errors contains "Material Interest" %} invalid{% endif %}'
          >
          <label class='checkbox__label' for='Gravel-{{ section.id }}'>Gravel</label>
        </div>
        <div class='checkbox-item'>
          <input
            type='checkbox'
            id='Boulder-{{ section.id }}'
            name='Material Interest'
            value='Boulder'
            class='checkbox__input{% if form.errors contains "Material Interest" %} invalid{% endif %}'
          >
          <label class='checkbox__label' for='Boulder-{{ section.id }}'>Boulder</label>
        </div>
        <div class='checkbox-item'>
          <input
            type='checkbox'
            id='Pavers-{{ section.id }}'
            name='Material Interest'
            value='Pavers'
            class='checkbox__input{% if form.errors contains "Material Interest" %} invalid{% endif %}'
          >
          <label class='checkbox__label' for='Pavers-{{ section.id }}'>Pavers</label>
        </div>
      </div>
    </div>

    <div class='field'>
      <textarea
        class='text-area field__input{% if form.errors contains "Message" %} invalid{% endif %}'
        id='Message-{{ section.id }}'
        name='Message'
        rows='4'
        required
        placeholder='Message'
      ></textarea>
      <label class='field__label' for='Message-{{ section.id }}'> Message* </label>
    </div>

    <div class='product-form__buttons'>
      <button
        type='submit'
        class='button product-form__submit'
      >
        Submit <span class='icon-arrow'>â†’</span>
      </button>
    </div>
  </div>
</form>

<style>
    /* Make the form scrollable on mobile */
    .custom-product-form {
      padding-bottom: 1rem;
    }
  
    .custom-form__fields {
      display: flex;
      flex-direction: column;
      gap: 2rem;
      padding-bottom: 1rem;
    }

    .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    .field-row:has(.field--note) {
      gap: 1rem;
    }

    @media screen and (max-width: 749px) {
      .field-row {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      .checkbox-group {
        flex-direction: column;
      }
    }
    .field--note {
      grid-column: 1 / -1;
    }
    .field--note p {
      margin: 0;
    }
    .checkbox-group {
      display: flex;
      gap: 1rem;
      padding: 2.2rem 1.5rem 0.8rem 0;
      border-bottom: 0.1rem solid rgb(var(--color-base-text));
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .checkbox__input {
      width: auto;
      margin: 0;
    }
    .checkbox__label {
      margin: 0;
    }
    .icon-arrow {
      transition: transform 0.2s ease;
    }

    .product-form__submit:hover .icon-arrow {
      transform: translateX(5px);
    }
    .form__message {
      flex-direction: column;
      align-items: baseline;
      border: none;
    }

    .form--success .form-status-list {
      display: block;
    }

    .form--success .custom-form__fields {
      display: none;
    }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('#custom_product_form')
    const inputs = form.querySelectorAll('.field__input')

    inputs.forEach((input) => {
      input.addEventListener('invalid', function (e) {
        e.preventDefault()
        this.classList.add('invalid')
      })

      input.addEventListener('input', function () {
        if (this.validity.valid) {
          this.classList.remove('invalid')
        }
      })
    })
  })
  // Klaviyo form submission
  document.querySelector('#custom_product_form').addEventListener('submit', async function (e) {
    e.preventDefault()

    const form = this
    const submitButton = form.querySelector('button[type="submit"]')
    const formFields = form.querySelector('.custom-form__fields')
    const formMessage = form.querySelector('.form__message')

    try {
      submitButton.disabled = true

      const email = this.querySelector('[name="Email"]').value
      const firstName = this.querySelector('[name="FirstName"]').value
      const lastName = this.querySelector('[name="LastName"]').value
      const phone = this.querySelector('[name="Phone"]').value
      const role = this.querySelector('[name="Role"]').value
      const streetAddress = this.querySelector('[name="Street Address"]').value
      const city = this.querySelector('[name="City"]').value
      const state = this.querySelector('[name="State"]').value
      const zip = this.querySelector('[name="Zip"]').value
      const squareFootage = this.querySelector('[name="Square Footage"]').value
      // Get all selected material interests
      const materialInterestCheckboxes = this.querySelectorAll('[name="Material Interest"]:checked')
      const materialInterests = Array.from(materialInterestCheckboxes)
        .map((checkbox) => checkbox.value)
        .join(', ')
      const message = this.querySelector('[name="Message"]').value

      // Wait for Klaviyo to be ready
      if (typeof _learnq === 'undefined') {
        await new Promise((resolve) => setTimeout(resolve, 1000))
      }

      // Identify the profile
      _learnq.push([
        'identify',
        {
          $email: email,
          $first_name: firstName,
          $last_name: lastName,
          $phone_number: phone,
          Role: role,
          $address1: streetAddress,
          $city: city,
          $state: state,
          $zip: zip,
          'Square Footage': squareFootage,
          'Material Interest': materialInterests,
          Message: message,
          Source: 'Product Inquiry Form',
          Product: '{{ product.title }}',
          Product_Type: '{{ product.type }}',
          Collections:
            '{% for collection in product.collections %}{{ collection.title }}{% unless forloop.last %}, {% endunless %}{% endfor %}',
          Inquiry_Date: new Date().toISOString()
        }
      ])

      // List subscription
      if ('{{ settings.klaviyo_list_id }}') {
        _learnq.push([
          'track',
          'Product Inquiry Form Submission',
          {
            $email: email,
            $first_name: firstName,
            $last_name: lastName,
            $phone_number: phone,
            Role: role,
            $address1: streetAddress,
            $city: city,
            $state: state,
            $zip: zip,
            'Square Footage': squareFootage,
            'Material Interest': materialInterests,
            Message: message,
            Source: 'Product Inquiry Form',
            Product: '{{ product.title }}',
            Product_Type: '{{ product.type }}',
            
          }
        ])
      }

      // Show success message
      formFields.style.display = 'none'
      formMessage.innerHTML = `
            <div class='form-status form-status-list form__message' tabindex='-1' autofocus>
                <p>Thank you for your inquiry about {{ product.title }}</p>
                <p>We'll get back to you as soon as possible.</p>
            </div>
        `
      formMessage.style.display = 'block'
    } catch (error) {
      console.error('Klaviyo submission error:', error)
      formMessage.innerHTML = `
            <div class='form__message' tabindex='-1' autofocus>
                <h2>{% render 'icon-error' %} There was a problem submitting your inquiry</h2>
                <p>Please try again later.</p>
            </div>
        `
      formMessage.style.display = 'block'
    } finally {
      submitButton.disabled = false
    }
  })
</script>
